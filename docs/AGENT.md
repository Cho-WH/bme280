# BME280 웹앱: 다음 이슈 해결 지침

이 문서는 `bme280/docs/project-overview.md` 기준으로 현재 데이터 흐름을 정리하고, 아래 2개 요구사항을 구현하기 위한 “구체적 작업 항목”을 정의합니다.

요구사항:
1. 로그에는 지난 데이터를 삭제하지 않고 모두 누적해서 기록해야 한다.
2. 그래프는 지난 1분간의 데이터 기록을 표시한다(600개).

## 1) 현재 흐름 요약(코드 기준)
- 데이터 수신: `bme280/js/bluetooth.js`에서 Nordic UART RX 알림을 라인 단위로 조립
- 파싱: `bme280/js/utils/parseSample.js`가 `"temperature,humidity,pressure"` 3필드를 `{ timestamp, temperature, humidity, pressure }`로 변환
- 상태 저장: `bme280/js/state.js`의 `actions.setSample()` → `state.history`에 append (현재는 `HISTORY_LIMIT=300`으로 잘림)
- 렌더링:
  - 그래프: `bme280/js/ui/magnet-chart.js`가 `state.history.slice(-HISTORY_WINDOW)`로 표시(현재 `HISTORY_WINDOW=120`)
  - 로그 표/CSV: `bme280/js/ui/data-log.js`가 최근 12개만 렌더(CSV 다운로드는 `state.history` 전체를 사용)

즉, 현재는 `state.history`가 “그래프/표/CSV 공용”이며, 길이 제한 때문에 과거 데이터가 삭제됩니다.

## 2) 목표 상태(설계 원칙)
- “로그(원본)”과 “그래프(뷰)”를 분리한다.
  - 로그: 삭제 없이 누적(세션 동안은 무제한 append, 필요 시 영속 저장까지 확장 가능)
  - 그래프: 최근 1분(600개)만 표시(고정 길이 슬라이딩 윈도우)
- UI 표시와 저장(데이터 보존)을 분리한다.
  - 표는 최근 일부만 보여도 되지만(성능), “데이터 자체”는 누적되어야 한다.

## 3) 구현 방안(권장: 원본 로그 + 차트 윈도우 분리)
### 3.1 상태 구조 변경(`bme280/js/state.js`)
1) `history`를 “로그 전용”으로 재정의(삭제 금지)
- `HISTORY_LIMIT`/`appendSample()`의 slice 로직 제거
- `state.history`는 무제한 append
  - 단, 사용자가 명시적으로 초기화하거나(버튼), 연결 해제/재연결 시에는 초기화 정책에 따라 로그를 비울 수 있다.

2) 차트 전용 윈도우 도입(600개)
둘 중 하나로 구현:
- (A) 상태에 `chartHistory`를 추가하고, `chartHistory`만 600으로 제한 (권장: 차트가 단순해짐)
- (B) 상태는 `history`만 유지하고, 차트에서 `history.slice(-600)`로 뷰를 계산 (권장: 상태 변경 최소)

권장 값:
- `CHART_WINDOW_SIZE = 600`
- `LOG_ROW_RENDER_LIMIT = 12`(표 렌더링만)

### 3.2 그래프 1분/600개 표시(`bme280/js/ui/magnet-chart.js`)
- `HISTORY_WINDOW`를 `600`으로 변경
- 데이터 소스는 아래 중 택 1
  - `state.chartHistory`
  - `state.history.slice(-600)`
- 표시 기준(중요): “600개”는 샘플링이 100ms(10Hz)일 때 1분이므로,
  - 펌웨어 샘플링 주기를 100ms로 맞추거나(`firmware/bme280.js`)
  - 또는 차트 뷰를 “최근 60초 타임스탬프 기준”으로 필터하고, 최대 600개로 제한하는 방식으로 보정한다.

### 3.3 로그 누적과 CSV(`bme280/js/ui/data-log.js`, `bme280/js/utils/csv.js`)
- 표 렌더링은 현재처럼 “최근 N개만 표시” 유지(성능 목적)
- CSV 다운로드는 “누적 로그 전체”를 사용
- 표 영역에 “총 누적 건수”를 함께 표시해(예: `총 12,345건`) “삭제 없이 누적 중”임을 사용자에게 명확히 보여준다.
  - 추가: “기록 초기화” 버튼으로 누적 로그를 즉시 비울 수 있게 한다.

## 4) 검증 체크리스트(완료 조건)
- 10분 이상 실행 후에도:
  - CSV 다운로드에 전체 로그가 포함된다(초기 데이터가 사라지지 않음).
  - 표는 최근 N개만 보이더라도, 누적 건수는 계속 증가한다.
  - 그래프는 항상 최근 600개(=최근 1분)만 보인다(초기 구간은 차트에서 자연스럽게 빠짐).

## 5) 리스크/주의사항(필수)
- 로그를 “무한 배열”로만 두면 장시간 사용 시 메모리가 증가한다.
  - 장기 운용이 목표라면 “IndexedDB에 append-only 저장 + 메모리에는 최근 일부만 유지(표/차트용)” 구조로 확장한다.
- “1분=600개” 조건은 샘플링 주기와 강하게 결합된다.
  - 실제 전송 주기(펌웨어/모의데이터)가 100ms인지 확인하고, 아니라면 “타임 기반 필터링”으로 정의를 명확히 한다.
